<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulse UI</title>
<style>
body {
    margin:0;
    padding:0;
    height:100vh;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    background:#111;
    color:#fff;
    font-family:Arial, sans-serif;
    overflow:hidden;
}
#pulse-circle {
    width:150px;
    height:150px;
    border-radius:50%;
    background: linear-gradient(135deg, #ff4dff, #9a00ff);
    box-shadow:0 0 50px rgba(154,0,255,0.7);
    transition: transform 0.05s ease, box-shadow 0.05s ease;
    margin-bottom:20px;
}
#info { font-size:18px; text-align:center; }
#bpm { font-size:32px; font-weight:bold; margin-top:10px; }
#start-btn {
    padding:12px 25px;
    font-size:18px;
    margin-top:20px;
    cursor:pointer;
    border:none;
    border-radius:8px;
    background-color:#9a00ff;
    color:#fff;
    transition: background 0.2s;
}
#start-btn:hover { background-color:#c715ff; }
video { display:none; }
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<div id="pulse-circle"></div>
<div id="info">Нажмите "Поехали" и положите палец на камеру</div>
<div id="bpm">-- BPM</div>
<button id="start-btn">Поехали jjj</button>

<script>
const video = document.getElementById('video');
const circle = document.getElementById('pulse-circle');
const bpmDisplay = document.getElementById('bpm');
const startBtn = document.getElementById('start-btn');

const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

let brightnessHistory = [];
let lastPeakTime = 0;
let pulseIntervals = [];

startBtn.addEventListener('click', async () => {
    startBtn.disabled = true;
    startBtn.textContent = "Подключаем камеру...";
    try {
        // Явный запрос камеры с опцией playsinline
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } }
        });
        video.srcObject = stream;
        startBtn.style.display = 'none';
        info.textContent = "Камера активна, положите палец на камеру";
        processFrame();
    } catch(e) {
        alert('Не удалось получить доступ к камере. Разрешите камеру в браузере: ' + e);
        startBtn.disabled = false;
        startBtn.textContent = "Поехали";
    }
});

function processFrame(){
    if(video.readyState >= 2){
        canvas.width = video.videoWidth/2;
        canvas.height = video.videoHeight/2;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const frame = ctx.getImageData(0,0,canvas.width,canvas.height).data;
        let sum=0;
        for(let i=0;i<frame.length;i+=4){ sum+=frame[i]+frame[i+1]+frame[i+2]; }
        const brightness = sum/(frame.length/4);
        brightnessHistory.push(brightness);
        if(brightnessHistory.length>200) brightnessHistory.shift();

        if(brightnessHistory.length>3){
            const last = brightnessHistory[brightnessHistory.length-1];
            const prev = brightnessHistory[brightnessHistory.length-2];
            const prev2 = brightnessHistory[brightnessHistory.length-3];
            if(prev>last && prev>prev2 && Date.now()-lastPeakTime>300){
                if(lastPeakTime!=0){
                    const interval = (Date.now()-lastPeakTime)/1000;
                    pulseIntervals.push(interval);
                    if(pulseIntervals.length>10) pulseIntervals.shift();
                    const avgInterval = pulseIntervals.reduce((a,b)=>a+b,0)/pulseIntervals.length;
                    const bpm = Math.round(60/avgInterval);
                    bpmDisplay.textContent = bpm+" BPM";
                }
                lastPeakTime = Date.now();
            }
        }

        const recent = brightnessHistory.slice(-5);
        let pulseStrength = (recent[recent.length-1]-recent[0])/30;
        pulseStrength = Math.min(Math.max(pulseStrength,0),0.5);

        circle.style.transform = scale(${1+pulseStrength});
        circle.style.
        boxShadow = 0 0 ${50+pulseStrength*50}px rgba(154,0,255,0.7);
    }
    requestAnimationFrame(processFrame);
}
</script>
</body>
</html>
