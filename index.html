<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulse UI</title>
<style>
    body {
        margin: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #111;
        color: #fff;
        font-family: Arial, sans-serif;
        flex-direction: column;
        overflow: hidden;
    }

    #pulse-circle {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff4d4d, #ff1a75);
        box-shadow: 0 0 50px rgba(255, 0, 100, 0.7);
        transition: transform 0.05s ease, box-shadow 0.05s ease;
        margin-bottom: 20px;
    }

    #info {
        font-size: 18px;
        text-align: center;
    }

    #bpm {
        font-size: 32px;
        font-weight: bold;
        margin-top: 10px;
    }

    #start-btn {
        padding: 12px 25px;
        font-size: 18px;
        margin-top: 20px;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        background-color: #ff1a75;
        color: #fff;
        transition: background 0.2s;
    }

    #start-btn:hover {
        background-color: #ff4d4d;
    }

    video {
        display: none;
    }
</style>
</head>
<body>

<video id="video" autoplay></video>
<div id="pulse-circle"></div>
<div id="info">Нажмите "Запустить камеру" и положите палец на камеру</div>
<div id="bpm">-- BPM</div>
<button id="start-btn">Запустить камеру</button>

<script>
const video = document.getElementById('video');
const circle = document.getElementById('pulse-circle');
const info = document.getElementById('info');
const bpmDisplay = document.getElementById('bpm');
const startBtn = document.getElementById('start-btn');

const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

let brightnessHistory = [];
let lastPeakTime = 0;
let pulseIntervals = [];
let usingCamera = false;

startBtn.addEventListener('click', () => {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
        video.srcObject = stream;
        usingCamera = true;
        startBtn.style.display = 'none';
        info.textContent = 'Положите палец на камеру';
    })
    .catch(err => {
        alert('Камера недоступна. Используется имитация пульса.');
        simulatePulse();
        startBtn.style.display = 'none';
        info.textContent = 'Имитация пульса активна';
    });
});

function processFrame() {
    if(usingCamera && video.readyState >= 2) {
        canvas.width = video.videoWidth/2;
        canvas.height = video.videoHeight/2;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const frame = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        let sum = 0;
        for(let i=0; i<frame.length; i+=4) {
            sum += frame[i] + frame[i+1] + frame[i+2];
        }
        const brightness = sum / (frame.length/4);
        brightnessHistory.push(brightness);

        if (brightnessHistory.length > 200) brightnessHistory.shift();

        // определение пиков
        if(brightnessHistory.length > 3) {
            const last = brightnessHistory[brightnessHistory.length-1];
            const prev = brightnessHistory[brightnessHistory.length-2];
            const prev2 = brightnessHistory[brightnessHistory.length-3];

            if(prev > last && prev > prev2 && Date.now() - lastPeakTime > 300) { // пик найден
                if(lastPeakTime != 0) {
                    const interval = (Date.now() - lastPeakTime)/1000; // секунды
                    pulseIntervals.push(interval);
                    if(pulseIntervals.length > 10) pulseIntervals.shift(); // среднее последних 10 ударов
                    const avgInterval = pulseIntervals.reduce((a,b)=>a+b,0)/pulseIntervals.length;
                    const bpm = Math.round(60/avgInterval);
                    bpmDisplay.textContent = bpm + " BPM";
                }
                lastPeakTime = Date.now();


                }
        }

        // визуализация пульса